---
title: "Homework 6"
author: "Xinyi Lin"
date: "11/16/2018"
output: github_document
---

```{r}
library(tidyverse)
library(modelr)
```

# Problem 1

## Import and tidy data

```{r}
homicide_df = read_csv("./data/homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state), 
         bin_diposition = ifelse(disposition == "Closed by arrest", 1, 0),
         victim_age = as.numeric(victim_age),
         victim_race = relevel(as.factor(victim_race), ref = "White"),
         victim_race_cate = ifelse(victim_race == "White", "white", "non-white"),
         victim_race_cate = relevel(as.factor(victim_race_cate), ref = "white")) %>% 
  #filter(city_state != "Dallas, TX")
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")

head(homicide_df)
```

## Baltimore, MD

```{r}
glm_Baltimore =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(bin_diposition ~ victim_age + victim_sex + victim_race, data = .) 

glm_Baltimore %>% 
  broom::tidy()

glm_Baltimore %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) 

glm_Baltimore %>% 
  confint()
```

So, the odds ratio of solving homicides comparing black victims to white victims keeping all other variable fixed is 0.82.

## Each city

```{r}
cities_glm =
  homicide_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(bin_diposition ~ victim_age + victim_sex + victim_race, data = .x)), 
         parameters = map(models, broom::tidy)) %>% 
  unnest(parameters) %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value)
```

# Problem 2

## Import and tidy data

```{r}
birthweight_df =
  read_csv("./data/birthweight.csv") %>% 
  mutate(frace = as.factor(frace)) 

head(birthweight_df)
```

## Propose model

Hypothesis: Assume `babysex`, `fincome` and `gaweeks` are three main factors which influence baby's birth weight.

First, we test `babysex`

```{r}
birthweight_df %>% 
  ggplot(aes(babysex, bwt, group = babysex)) +
  geom_boxplot()
```

According to the results, sex has little influence on baby's birh weight. Then, we test `fincome`.

```{r}
birthweight_df %>% 
  ggplot(aes(fincome, bwt)) +
  geom_point() +
  geom_smooth()
```

The plot above shows family monthly income influence average birth weight of baby. Finally, we test `gaweeks`.

```{r}
birthweight_df %>% 
  ggplot(aes(gaweeks, bwt)) +
  geom_point() +
  geom_smooth()
```

Gestational age seems to influence baby's birth weight as well. So we create models with three factors. As these three factor have no relationship with each other, we treated them as main effects only.

```{r}
own_model = lm(bwt ~ babysex + fincome + gaweeks, data = birthweight_df) 

broom::tidy(own_model)

broom::glance(own_model)
```

Now, we show the plot of model residuals against fitted values.

```{r}
birthweight_df %>% 
  add_predictions(own_model) %>% 
  add_residuals(own_model) %>% 
  ggplot(aes(pred, resid)) +
  geom_hex()
```

## Cross validation 

```{r}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))
```

```{r}
cv_df = 
  cv_df %>% 
  mutate(own_mod = map(train, ~lm(bwt ~ babysex + fincome + gaweeks, data = .x)),
         compared_mod1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         compared_mod2 = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + blength*babysex + babysex*bhead + bhead*blength*babysex, data = .x))) %>% 
  mutate(rmse_own = map2_dbl(own_mod, test, ~rmse(model = .x, data = .y)),
         rmse_mod1 = map2_dbl(compared_mod1, test, ~rmse(model = .x, data = .y)),
         rmse_mod2 = map2_dbl(compared_mod2, test, ~rmse(model = .x, data = .y)))
```

Visualization

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

