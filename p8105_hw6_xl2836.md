Homework 6
================
Xinyi Lin
11/16/2018

``` r
library(tidyverse)
```

    ## ── Attaching packages ──────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──

    ## ✔ ggplot2 3.0.0     ✔ purrr   0.2.5
    ## ✔ tibble  1.4.2     ✔ dplyr   0.7.6
    ## ✔ tidyr   0.8.1     ✔ stringr 1.3.1
    ## ✔ readr   1.1.1     ✔ forcats 0.3.0

    ## ── Conflicts ─────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(modelr)
```

Problem 1
=========

Import and tidy data
--------------------

``` r
homicide_df = read_csv("./data/homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state), 
         bin_diposition = ifelse(disposition == "Closed by arrest", 1, 0),
         victim_age = as.numeric(victim_age),
         victim_race = relevel(as.factor(victim_race), ref = "White"),
         victim_race_cate = ifelse(victim_race == "White", "white", "non-white"),
         victim_race_cate = relevel(as.factor(victim_race_cate), ref = "white")) %>% 
  #filter(city_state != "Dallas, TX")
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_integer(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_character(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

    ## Warning in evalq(as.numeric(victim_age), <environment>): NAs introduced by
    ## coercion

``` r
head(homicide_df)
```

    ## # A tibble: 6 x 15
    ##   uid   reported_date victim_last victim_first victim_race victim_age
    ##   <chr>         <int> <chr>       <chr>        <fct>            <dbl>
    ## 1 Alb-…      20100504 GARCIA      JUAN         Hispanic            78
    ## 2 Alb-…      20100216 MONTOYA     CAMERON      Hispanic            17
    ## 3 Alb-…      20100601 SATTERFIELD VIVIANA      White               15
    ## 4 Alb-…      20100101 MENDIOLA    CARLOS       Hispanic            32
    ## 5 Alb-…      20100102 MULA        VIVIAN       White               72
    ## 6 Alb-…      20100126 BOOK        GERALDINE    White               91
    ## # ... with 9 more variables: victim_sex <chr>, city <chr>, state <chr>,
    ## #   lat <dbl>, lon <dbl>, disposition <chr>, city_state <chr>,
    ## #   bin_diposition <dbl>, victim_race_cate <fct>

Baltimore, MD
-------------

``` r
glm_Baltimore =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(bin_diposition ~ victim_age + victim_sex + victim_race, data = .) 

glm_Baltimore %>% 
  broom::tidy()
```

    ## # A tibble: 7 x 5
    ##   term                estimate std.error statistic  p.value
    ##   <chr>                  <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)          0.777    0.0521      14.9   1.62e-48
    ## 2 victim_age          -0.00161  0.000721    -2.23  2.58e- 2
    ## 3 victim_sexMale      -0.209    0.0315      -6.66  3.33e-11
    ## 4 victim_raceAsian     0.0681   0.147        0.463 6.43e- 1
    ## 5 victim_raceBlack    -0.198    0.0400      -4.96  7.53e- 7
    ## 6 victim_raceHispanic -0.0625   0.0734      -0.851 3.95e- 1
    ## 7 victim_raceOther    -0.182    0.196       -0.927 3.54e- 1

``` r
glm_Baltimore %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) 
```

    ## # A tibble: 7 x 4
    ##   term                  log_OR    OR  p.value
    ##   <chr>                  <dbl> <dbl>    <dbl>
    ## 1 (Intercept)          0.777   2.18  1.62e-48
    ## 2 victim_age          -0.00161 0.998 2.58e- 2
    ## 3 victim_sexMale      -0.209   0.811 3.33e-11
    ## 4 victim_raceAsian     0.0681  1.07  6.43e- 1
    ## 5 victim_raceBlack    -0.198   0.820 7.53e- 7
    ## 6 victim_raceHispanic -0.0625  0.939 3.95e- 1
    ## 7 victim_raceOther    -0.182   0.834 3.54e- 1

``` r
glm_Baltimore %>% 
  confint()
```

    ## Waiting for profiling to be done...

    ##                            2.5 %        97.5 %
    ## (Intercept)          0.675229354  0.8794382604
    ## victim_age          -0.003021332 -0.0001948731
    ## victim_sexMale      -0.271107384 -0.1477875120
    ## victim_raceAsian    -0.220059766  0.3562145690
    ## victim_raceBlack    -0.276513313 -0.1198399803
    ## victim_raceHispanic -0.206474308  0.0814221618
    ## victim_raceOther    -0.566830586  0.2027872204

So, the odds ratio of solving homicides comparing black victims to white victims keeping all other variable fixed is 0.82.

Each city
---------

``` r
cities_glm =
  homicide_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(bin_diposition ~ victim_age + victim_sex + victim_race, data = .x)), 
         parameters = map(models, broom::tidy)) %>% 
  unnest(parameters) %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value)
```

Problem 2
=========

Import and tidy data
--------------------

``` r
birthweight_df =
  read_csv("./data/birthweight.csv") %>% 
  mutate(frace = as.factor(frace)) 
```

    ## Parsed with column specification:
    ## cols(
    ##   .default = col_integer(),
    ##   gaweeks = col_double(),
    ##   ppbmi = col_double(),
    ##   smoken = col_double()
    ## )

    ## See spec(...) for full column specifications.

``` r
head(birthweight_df)
```

    ## # A tibble: 6 x 20
    ##   babysex bhead blength   bwt delwt fincome frace gaweeks malform menarche
    ##     <int> <int>   <int> <int> <int>   <int> <fct>   <dbl>   <int>    <int>
    ## 1       2    34      51  3629   177      35 1        39.9       0       13
    ## 2       1    34      48  3062   156      65 2        25.9       0       14
    ## 3       2    36      50  3345   148      85 1        39.9       0       12
    ## 4       1    34      52  3062   157      55 1        40         0       14
    ## 5       2    34      52  3374   156       5 1        41.6       0       13
    ## 6       1    33      52  3374   129      55 1        40.7       0       12
    ## # ... with 10 more variables: mheight <int>, momage <int>, mrace <int>,
    ## #   parity <int>, pnumlbw <int>, pnumsga <int>, ppbmi <dbl>, ppwt <int>,
    ## #   smoken <dbl>, wtgain <int>

Propose model
-------------

Hypothesis: Assume `babysex`, `fincome` and `gaweeks` are three main factors which influence baby's birth weight.

First, we test `babysex`

``` r
birthweight_df %>% 
  ggplot(aes(babysex, bwt, group = babysex)) +
  geom_boxplot()
```

![](p8105_hw6_xl2836_files/figure-markdown_github/unnamed-chunk-6-1.png)

According to the results, sex has little influence on baby's birh weight. Then, we test `fincome`.

``` r
birthweight_df %>% 
  ggplot(aes(fincome, bwt)) +
  geom_point() +
  geom_smooth()
```

    ## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'

![](p8105_hw6_xl2836_files/figure-markdown_github/unnamed-chunk-7-1.png)

The plot above shows family monthly income influence average birth weight of baby. Finally, we test `gaweeks`.

``` r
birthweight_df %>% 
  ggplot(aes(gaweeks, bwt)) +
  geom_point() +
  geom_smooth()
```

    ## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'

![](p8105_hw6_xl2836_files/figure-markdown_github/unnamed-chunk-8-1.png)

Gestational age seems to influence baby's birth weight as well. So we create models with three factors. As these three factor have no relationship with each other, we treated them as main effects only.

``` r
own_model = lm(bwt ~ babysex + fincome + gaweeks, data = birthweight_df) 

broom::tidy(own_model)
```

    ## # A tibble: 4 x 5
    ##   term        estimate std.error statistic   p.value
    ##   <chr>          <dbl>     <dbl>     <dbl>     <dbl>
    ## 1 (Intercept)   584.      89.8        6.51 8.64e- 11
    ## 2 babysex       -94.6     14.0       -6.75 1.62e- 11
    ## 3 fincome         2.16     0.271      7.97 1.96e- 15
    ## 4 gaweeks        65.3      2.23      29.3  3.53e-172

``` r
broom::glance(own_model)
```

    ## # A tibble: 1 x 11
    ##   r.squared adj.r.squared sigma statistic   p.value    df  logLik    AIC
    ## *     <dbl>         <dbl> <dbl>     <dbl>     <dbl> <int>   <dbl>  <dbl>
    ## 1     0.191         0.190  461.      341. 9.08e-199     4 -32789. 65588.
    ## # ... with 3 more variables: BIC <dbl>, deviance <dbl>, df.residual <int>

Now, we show the plot of model residuals against fitted values.

``` r
birthweight_df %>% 
  add_predictions(own_model) %>% 
  add_residuals(own_model) %>% 
  ggplot(aes(pred, resid)) +
  geom_hex()
```

![](p8105_hw6_xl2836_files/figure-markdown_github/unnamed-chunk-10-1.png)

Cross validation
----------------

``` r
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))
```

``` r
cv_df = 
  cv_df %>% 
  mutate(own_mod = map(train, ~lm(bwt ~ babysex + fincome + gaweeks, data = .x)),
         compared_mod1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         compared_mod2 = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + blength*babysex + babysex*bhead + bhead*blength*babysex, data = .x))) %>% 
  mutate(rmse_own = map2_dbl(own_mod, test, ~rmse(model = .x, data = .y)),
         rmse_mod1 = map2_dbl(compared_mod1, test, ~rmse(model = .x, data = .y)),
         rmse_mod2 = map2_dbl(compared_mod2, test, ~rmse(model = .x, data = .y)))
```

Visualization

``` r
cv_df %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

![](p8105_hw6_xl2836_files/figure-markdown_github/unnamed-chunk-13-1.png)
